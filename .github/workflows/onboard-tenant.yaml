name: Onboard New Tenant

on:
  workflow_dispatch:
    inputs:
      customerName:
        description: 'Customer/Developer name (e.g., customer2, john)'
        required: true
        type: string
      envType:
        description: 'Environment type'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
      customDomain:
        description: 'Custom ingress domain (optional)'
        required: false
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      tenant-name: ${{ steps.determine.outputs.tenant-name }}
    steps:
      - name: Validate inputs
        run: |
          if [[ -z "${{ inputs.customerName }}" ]]; then
            echo "Error: Customer name is required"
            exit 1
          fi

          # Check for invalid characters
          if [[ ! "${{ inputs.customerName }}" =~ ^[a-z0-9-]+$ ]]; then
            echo "Error: Customer name must contain only lowercase letters, numbers, and hyphens"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Determine tenant name
        id: determine
        run: |
          CUSTOMER="${{ inputs.customerName }}"
          ENV="${{ inputs.envType }}"

          # Developer personal env format: dev-<name>
          # Customer env format: <customer>-<env>
          if [[ "$ENV" == "dev" && ! "$CUSTOMER" =~ ^customer ]]; then
            TENANT="dev-$CUSTOMER"
          else
            TENANT="$CUSTOMER-$ENV"
          fi

          echo "tenant-name=$TENANT" >> $GITHUB_OUTPUT
          echo "Tenant name will be: $TENANT"

      - name: Check if tenant exists
        run: |
          TENANT="${{ steps.determine.outputs.tenant-name }}"
          if [[ -d "tenants/$TENANT" ]]; then
            echo "Error: Tenant $TENANT already exists"
            exit 1
          fi

  onboard:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_TOKEN }}

      - name: Setup tools
        run: |
          # Install yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Create tenant
        run: |
          ./scripts/onboard-tenant.sh "${{ inputs.customerName }}" "${{ inputs.envType }}"

      - name: Apply custom domain
        if: inputs.customDomain != ''
        run: |
          TENANT="${{ needs.validate.outputs.tenant-name }}"
          yq eval ".services.ui.ingress.domain = \"${{ inputs.customDomain }}\"" -i "tenants/$TENANT/overrides.yaml"
          ./scripts/merge-values.sh "$TENANT"

      - name: Commit and push
        run: |
          TENANT="${{ needs.validate.outputs.tenant-name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "tenants/$TENANT"
          git commit -m "Onboard tenant: $TENANT

          Customer: ${{ inputs.customerName }}
          Environment: ${{ inputs.envType }}
          Namespace: ns-$TENANT

          Triggered by: ${{ github.actor }}"
          git push

      - name: Summary
        run: |
          TENANT="${{ needs.validate.outputs.tenant-name }}"
          echo "## Tenant Onboarded" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant | $TENANT |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ns-$TENANT |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.envType }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Customer | ${{ inputs.customerName }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically create applications for this tenant." >> $GITHUB_STEP_SUMMARY
